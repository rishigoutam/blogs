<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Rishi Goutam, Srikar Pamidi, James Goudreault">
  <meta name="dcterms.date" content="2022-04-07">
  <meta name="keywords" content="LSTM; SARIMA; Citi Bike; NYC Data
Science Academy">
  <title>Predicting Citi Bike Trip Demand</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../../src/styles/tufte.css">
  <link rel="stylesheet" href="../../src/styles/pandoc.css">
  <link rel="stylesheet" href="../../src/styles/pandoc-solarized.css">
  <link rel="stylesheet" href="../../src/styles/tufte-extra.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article>
<header>
<h1 class="title">Predicting Citi Bike Trip Demand</h1>
<p class="subtitle">Using a neural network model to predict ridership
based on time and weather</p>
<p class="byline">April 7, 2022 &ndash; Rishi Goutam, Srikar Pamidi,
James Goudreault</p>
</header>
<section id="predicting-citi-bike-trip-demand" class="level1">
<h1>Predicting Citi Bike Trip Demand</h1>
<p>In this article, we show how we analyzed the Citi Bike dataset and
built a model to predict ridership based on seasonality and weather.</p>
<section id="introduction" class="level2">
<h2>Introduction</h2>
<p>Citi Bike opened in New York City in 2013<span
class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle"/><span
class="sidenote">Citi Bike operates in multiple areas and has been
active for several years. We focused our analysis on the primary NYC
boroughs Citi Bike operates in (Manhattan, Brooklyn, and Queens). Unless
otherwise specified, statistics and graphics in this article are for the
year 2019 and these boroughs <img
src="https://hackmd.io/_uploads/B1hC_xnX9.png" /><br />
<br />
</span></span> and has since grown in ridership, bikes, and bike dock
stations. Predicting demand for bikes is important for Motivate, Citi
Bike’s parent company, in order to both reduce operating costs and
increase ridership. Costs are incurred by having under-utilized bikes on
the streets by wear-and-tear on bikes due to exposure to the elements or
other forms of damage, so it is necessary to warehouse bikes if they are
not serving riders. However, having too few a number of bikes available
leads to a poor customer experience and loss of revenue due to
dissatisfied customers.</p>
<p>We aim to first understand what features drive demand and then to
create a predictive model. Finally, we compare our model against the
actual number of trips to evaluate its usefulness.</p>
</section>
<section id="analyzing-the-data" class="level2">
<h2>Analyzing the data</h2>
<p>We focused our exploratory data analysis on:</p>
<ul>
<li>Rider demographics</li>
<li>Citi Bike’s growth and resilience in the face of COVID-19</li>
<li>Time (Seasonality)</li>
<li>Weather</li>
</ul>
<p>And determined that time and some weather conditions would make for
good predictors for a time-series model. Here is that analysis.</p>
<section id="demographics" class="level3">
<h3>Demographics</h3>
<p>By age, most riders are between 20 and 40 years and are mostly male.
Citi Bike has two classes of riders–annual subscribers and single-ride
or day pass purchasers. We see a default age of 50 years for riders
purchasing one-off trips or passes in the chart below.</p>
<p><img src="https://hackmd.io/_uploads/HkmjbY2Q5.png" /></p>
</section>
</section>
</section>
<section id="todo-fix-the-y-axis-here" class="level1">
<h1>TODO FIX THE Y AXIS HERE:</h1>
<p><img src="https://hackmd.io/_uploads/ByZCwthm5.png" /></p>
<p>We can see the gender and customer type distribution through the
much-maligned pie chart</p>
<p><img src="https://hackmd.io/_uploads/HJmSOKn75.png" /><img
src="https://hackmd.io/_uploads/SJYruY27c.png" /></p>
<section id="growth-and-resilience-of-citi-bike" class="level3">
<h3>Growth and Resilience of Citi Bike</h3>
<p>As the number of Citi Bike trips grows, operational efficiency is
more important to company finances. In addition, there is need for
accurately predicting demand and rebalancing stations effectively</p>
<p><img src="https://hackmd.io/_uploads/rkAj_YnXq.png" /></p>
<p>Bike stations appear to expand along subway lines…potential for
further expansion into Brooklyn, the Bronx, or Queens?</p>
<p><img src="https://hackmd.io/_uploads/SJXDFY3mq.png" /></p>
<p>While Citi Bike is not used as much as mass transit in NYC, it
offered a way for city residents to move from A to B during the pandemic
that wasn’t in an enclosed space…perhaps this is why it didn’t see as
sharp a drop in demand compared to the NYC subway or buses</p>
<p><img src="https://hackmd.io/_uploads/HkI3YYn7c.png" /></p>
</section>
<section id="temporal-analysis" class="level3">
<h3>Temporal Analysis</h3>
<p>We see increased usage in the summer as one might expect, but not all
summer days prove to have high counts.</p>
<p>Labor Day 2019 shows reduced demand…and weather might also play an
effect. We examine that later.</p>
<p><img src="https://hackmd.io/_uploads/SkpMqK2m9.png"
width="250" /><img src="https://hackmd.io/_uploads/B1Rs9tn7c.png" /> {
width=250px }</p>
<p>Surprisingly, weekends, especially Sunday, seem to have lower trip
counts on average than weekday. Sunday truly is the day of rest.</p>
<p><img src="https://hackmd.io/_uploads/BJodoYnXc.png"
width="250" /></p>
<p>Looks like commuters make up a bulk of trips given the high trip
counts around 8am and 5pm. This also explains the reduced number of
trips on weekends.</p>
<p><img src="https://hackmd.io/_uploads/HJIV2jhQ5.png"
width="250" /></p>
</section>
<section id="weather" class="level3">
<h3>Weather</h3>
<p>We began by looking at daily average temperature and found that trip
demand is highly correlated with it. We can use this as a model
predictor!</p>
<p><img src="https://hackmd.io/_uploads/rJcchi2Qc.png" /></p>
<p>We wanted to investigate whether weather conditions might have an
effect on number of trips…however, only saw decrease for days with
precipitation (rain/snow)</p>
<p>Conditions like fog (all types), thunder, or haze were low in terms
of number of days and did not have as strong an effect (although we were
surprised by the positive effect)</p>
<p><img src="https://hackmd.io/_uploads/ByVAno379.png" /></p>
<p>Digging deeper into rain, we wanted to see if the amount of rain
mattered…and it does! (as expected)</p>
<p><img src="https://hackmd.io/_uploads/ByyeajnQc.png" /></p>
<p>Based on this analysis, we decided to create a model incorporating
time, average temperature, and amount of precipitation in order to
predict the number of trips.</p>
</section>
<section id="trip-demand-prediction-models" class="level2">
<h2>Trip Demand Prediction Models</h2>
<p>We attempted two models, the first of our models is the traditional
SARIMA model, the second was a Long Short-Term Memory Recurrent Neural
Network (LSTM-RNN). In this, we further distinguish the models by the
time resolution, and whether or not the model was including weather data
(i.e. had multidimensional inputs). Notably absent from our treatment is
a vectorized SARIMA model or SVARIMA; however, this was due to time
considerations and the fact that LSTM-RNN models on average demonstrate
far better performance on multidimensional time series than traditional
models and approaches.</p>
<p>The population data is found in in the seconds resolution; however,
at this resolution, observations are not continously present and we have
long gaps for many seconds of the year with zero ridership. We take a
look at the hourly ridership data from 2019; whatever model we create
for one year we can easily generalize to multiple years.</p>
<p>As a preliminary assesment of the data, we look at the ridership over
the year along different timescales–in doing so we can begin to
understand trends and seasonality relationships within the day. Changing
the scale of our data, as we will see, is akin to passing the “wave” of
our time series through a low-pass filter, giving us lower frequency
relationships. Therefore, if there is high seasonality at low timescale,
this will be erased as we increase our timescale and aggregate over
larger steps.</p>
<p><img src="https://hackmd.io/_uploads/Sk1BWhhm9.png" /></p>
<p><img src="https://hackmd.io/_uploads/B1Gsio3Qc.png" /></p>
<p><img src="https://hackmd.io/_uploads/HJsb3ohQ5.png" /></p>
<p>We can see from the above graphs that weekly resolution is far too
sparse to caputure meaningful relationships. Therefore, we would like to
build models that predict at the Hourly timescale if we can, and if not,
then use the Daily timescale</p>
<p>At the sub hourly timescale, the data became too unweildy and noisy
for a years worth, let alone for the many years of data Citibike has
available. However in future extensions of this project we would like to
take a second level resolution for one week for one station and predict
the ridership at that level.</p>
<p>Our models were thus:</p>
<ol type="1">
<li>Hourly SARIMA, which did not converge to parameters.</li>
<li>Daily SARIMA, which converged to parameters, but had low
resolution.</li>
<li>Daily LSTM-RNN, without weather, which had high RMS error.</li>
<li>Daily LSTM-RNN with weather, which had reduced RMS error.</li>
<li>Hourly LSTM-RNN without weather, which had great success.</li>
<li>Hourly LSTM-RNN for a specific station, with weather.</li>
</ol>
<p>We compared these models by producing the Daily and Hourly RMSE and
comparing them to find the RMSE minimizing model.</p>
<section
id="seasonal-differencing-autoregressive-integrated-moving-average-sarima"
class="level3">
<h3>Seasonal-differencing autoregressive integrated moving average
(SARIMA)</h3>
<section id="hourly-sarima" class="level4">
<h4>Hourly SARIMA:</h4>
<p>To begin, we start with a model that does not account for the
weather, or uses deep learning, only traditional statistical metrics
based on past data.</p>
<section id="differencing" class="level5">
<h5>Differencing</h5>
</section>
<section id="acfpacf" class="level5">
<h5>ACF/PACF</h5>
</section>
<section id="box-ljung" class="level5">
<h5>Box-Ljung</h5>
</section>
<section id="seasonal-differencing" class="level5">
<h5>Seasonal Differencing</h5>
</section>
<section id="seasonal-acfpacf" class="level5">
<h5>Seasonal ACF/PACF</h5>
</section>
<section id="fitting" class="level5">
<h5>Fitting</h5>
<ul>
<li>failure to converge to parameters</li>
<li>hypothesis and next step for model</li>
</ul>
</section>
</section>
<section id="daily-sarima" class="level4">
<h4>Daily SARIMA:</h4>
<ul>
<li>diff, ACF, PACF, Box-Ljung, seasonal diff, SACF, SPACF, and
fitting</li>
<li>Converges to parameters</li>
<li>Prediction and visualization</li>
<li>Daily RMSE, avg hourly RMSE</li>
<li>Hypothesis and next step for model</li>
</ul>
</section>
</section>
<section id="long-short-term-memory-recurrent-neural-network-lstm"
class="level3">
<h3>Long short-term memory recurrent neural network (LSTM)</h3>
<section id="intro-to-rnn-and-lstmrnn" class="level4">
<h4>Intro to RNN and LSTMRNN</h4>
</section>
<section id="moving-from-sarima-to-lstmrnn" class="level4">
<h4>Moving from SARIMA to LSTMRNN</h4>
</section>
<section id="timeseries-and-backtesting" class="level4">
<h4>Timeseries and Backtesting</h4>
</section>
<section id="daily-lstmrnn" class="level4">
<h4>Daily LSTMRNN,</h4>
<ul>
<li>EDA and visuals</li>
<li>Seasonality, ACF, periodicity,</li>
<li>Structure of Layers and LSTMRNN</li>
<li>Backtesting and Visualization</li>
<li>Predictions and visualization</li>
<li>Daily RMSE and av hourly RMSE</li>
<li>Hypothesis and next step to improve</li>
</ul>
</section>
<section id="daily-wweather" class="level4">
<h4>Daily w/weather</h4>
<ul>
<li>Weather EDA, why we think to add temp and precipitation.</li>
<li>Seasonality ACF periodicity,</li>
<li>Layerstructure and adding more dimesions for lag</li>
<li>Predictions and Vis.</li>
<li>Daily RMSE and av hourly RMSE</li>
<li>Hypothesis and next step to improve</li>
</ul>
</section>
<section id="hourly-lstmrnn-without-weather-great-success."
class="level4">
<h4>Hourly LSTMRNN without weather, great success.</h4>
<ul>
<li>Hourly EDA, for busiest station.</li>
<li>Seasonality ACF periodicity,</li>
<li>Layerstructure and adding more dimesions for lag</li>
<li>Predictions and Vis.</li>
<li>Daily RMSE and av hourly RMSE</li>
<li>Hypothesis and next step to improve</li>
</ul>
</section>
<section
id="hourly-lstmrnn-for-a-specific-station-with-weather-great-success."
class="level4">
<h4>Hourly LSTMRNN for a specific station, with weather, great
success.</h4>
<ul>
<li>Hourly Weather EDA, why we think to add temp and precipitation.</li>
<li>Seasonality ACF periodicity,</li>
<li>Layerstructure and adding more dimesions for lag</li>
<li>Predictions and Vis.</li>
<li>Daily RMSE and av hourly RMSE</li>
<li>Hypothesis and next step to improve</li>
</ul>
</section>
</section>
<section id="conclusion" class="level3">
<h3>Conclusion</h3>
<p>We found such and such…</p>
</section>
</section>
<section id="rebalance-operations" class="level2">
<h2>Rebalance Operations</h2>
<section id="what-is-rebalancing-why-do-we-care" class="level3">
<h3>What is rebalancing? Why do we care?</h3>
<p>Citi Bike faces a perpetual dilema - how can they ensure there are
enough bikes in the right places to satisfy rider demand? Will the
natural flow of bikes from rider be enough?</p>
<p>Consider the flow of bikes through a popular commuter station on a
weekday:</p>
<figure>
<img src="https://hackmd.io/_uploads/B1Cspm979.jpg"
alt="Commuter-Station-Bike-Flow" />
<figcaption aria-hidden="true">Commuter-Station-Bike-Flow</figcaption>
</figure>
<p>The blue line represents the cumulative change in quantity of bikes
at the station throughout the day. The gray and red lines represent the
typical and maximum high-volume dock station capacities
respectively.</p>
<p>Even if the station were to naturally start each day fully stocked,
the station would be depleted halfway through morning commuter hours
with significant remaining demand. Someone needs to bring in more bikes
so all riders can get to work - and conversely shuffle them away at the
end of the day…</p>
<p>Simply put, rebalancing is the manual movement of bikes from one
station to another to: - ensure there are sufficient bikes at each dock
station to satisfy predicted demand - ensure there is space at ending
dock station to receive incoming bikes - minimize number of
underutilized bikes sitting at unpopular locations</p>
</section>
<section id="how-does-citi-bike-rebalance" class="level3">
<h3>How does Citi Bike Rebalance?</h3>
<p>Citi Bike employs several methods to manage rebalancing needs:</p>
<ul>
<li><em>Valet Service</em> - team members staff popular stations to
manage incoming and outgoing bikes, artificially elevating station
capacity and temporarily alleviating rush-hour problems</li>
<li><em>Bike Trains</em> - team members ride ebikes towing carriages of
12-16 bikes, ideal for rebalances in and around tight neghborhood
streets</li>
<li><em>Motorized Vehicles</em> - higher capacity vans operate 24/7 to
keep bikes moving to and from the most popular stations</li>
<li><em>Bike Angels</em> - Launched in 2018, this program grants Citi
Bike riders (non-employees) traveling along in-demand rebalance routes a
free trip and rewards points</li>
</ul>
</section>
<section id="identifying-rebalance-movements" class="level3">
<h3>Identifying Rebalance Movements</h3>
<p>The Citi Bike dataset does not contain information on individual bike
rebalances, nor is that generally available online except as aggregated
data in monthly reports. So how can someone tell when a bike was
rebalanced, and to where?</p>
<figure>
<img src="https://hackmd.io/_uploads/HkE2EN9m5.jpg"
alt="Identifying-Rebalances" />
<figcaption aria-hidden="true">Identifying-Rebalances</figcaption>
</figure>
<p>The easiest method to do so is (for a given bike) compare the
starting station for each trip with the ending station of the previous
trip. If the bike appears to have teleported from one station to another
between trips, it most likely was rebalanced!</p>
</section>
<section id="general-rebalance-statistics" class="level3">
<h3>General Rebalance Statistics</h3>
<p>Predictably, the number of rebalance operations increases with number
of rides. The large drop after 2017 coincides with the introduction of
the Bike Angels program and clearly demonstrates how successful this
clever initiative is.</p>
<p><img src="https://hackmd.io/_uploads/HyMLHN9mc.jpg" width="350"
alt="Rides-vs-Rebalances" /> <img
src="https://hackmd.io/_uploads/BkctLE9Xc.png" width="350"
alt="Rides-per-year" /></p>
<p>For each year, almost every unique bike in service was rebalanced at
least once and almost every station was invovled in rebalancing
operations.</p>
<p><img src="https://hackmd.io/_uploads/SkDsi4qX5.jpg" width="350"
alt="rebalancing-unique-bikes" /> <img
src="https://hackmd.io/_uploads/Hycis4qm9.jpg" width="350"
alt="rebalancing-unique-stations" /></p>
<p>The vast majority of rides occurred in Manhattan, so it is not
suprising to see that is where most rebalance activity occurs. <img
src="https://hackmd.io/_uploads/S1OGFI9X9.png"
alt="Rebalance-By-Boro" /></p>
<p>It is important to note that bikes are rebalaced around and across
all Boros - confirming Citi Bike actively works to satisfy all rider
demand. <img src="https://hackmd.io/_uploads/ryYuFUc79.png"
alt="Log-Rebalance-By-Boro" /></p>
<p>Individual stations with the highest rebalanace activity are mostly
commuter stations. Many have both a high number of bikes moved to and
from them based on commuter demands as shown above. <img
src="https://hackmd.io/_uploads/BkEV6dhX9.png"
alt="Stations-Rebalance" /></p>
</section>
<section id="rebalance-routes" class="level3">
<h3>Rebalance Routes</h3>
<p>We can glean more information about rebalance operations if we look
not just at bikes moving to and from individual stations, but consider
pairwise movement between two stations.</p>
<figure>
<img src="https://hackmd.io/_uploads/HJhBaLqXq.png"
alt="Rebalance-Routes" />
<figcaption aria-hidden="true">Rebalance-Routes</figcaption>
</figure>
<p>Not only is the majority of rebalance activity focused on a small
number of stations in Manhattan, most of it occurs between a small
number of station pairs. This makes sense in the context of commuter
bike flow, where there is a need for a constant flow of bikes away from
destination stations to origin stations to keep up with demand.</p>
<p>Notice that some of the top routes are just the reverse direction of
others. Visualizing bi-directional flow between station pairs further
emphasizes how critical rebalance operations are between a small number
of station pairs.</p>
<figure>
<img src="https://hackmd.io/_uploads/S1nzCI979.png"
alt="Bi-Directional-Rebalance-Routes" />
<figcaption
aria-hidden="true">Bi-Directional-Rebalance-Routes</figcaption>
</figure>
<p>It should be noted that rebalance operations are probably more
nuanced then bikes being moved along static ‘routes’ - it’s very
possible a van will stop at several stations along a circuit - but this
aggregate analysis still helps us understand how much effort and expense
is required to support the highest volume stations.</p>
<p>Perhaps the most intersting way to look at station related rebalance
data is visualized on a map - check out our dash app to see this for
2019!</p>
</section>
<section id="rebalance-timing" class="level3">
<h3>Rebalance Timing</h3>
<p>We don’t know precisely when a bike was rebalanced, only when a trip
started after the bike was rebalanced These time estimates (in hours)
all reflect the maximum time a rebalance operation could take. We can
conclusively say a good part of Citi Bike rebalancing is done to
alleviate immediate demand, such as during commutes.</p>
<figure>
<img src="https://hackmd.io/_uploads/r1La58cX9.png" width="350"
alt="Rebalance-Timing" />
<figcaption aria-hidden="true">Rebalance-Timing</figcaption>
</figure>
<p>Again, it appears that the Bike Angels program and Valet Service had
profound impacts on the need for immediate rebalances. <img
src="https://hackmd.io/_uploads/SyWzoL5X9.png"
alt="Rebalance-Timing-YearFacet" /></p>
<p>It appears that there are different reblance strategies used for
popular stations. Some seem to have the majority of rebalances done
overnight while others seem to be more frequently rebalanced for
immediate use. Both modes are necessary to keep up with demand. <img
src="https://hackmd.io/_uploads/r1ZQaKh75.png"
alt="Rebalance-Timing-Stations" /></p>
<p>Investigating timing for rebalance routes provides deeper insight,
where we can see some routes are used to stock stations overnight for
the next day’s commute and others are used to satisfy immediate demand.
<img src="https://hackmd.io/_uploads/ryMH6t2m9.png"
alt="Rebalance-Timing-Station-Pairs" /></p>
</section>
<section id="seasonality" class="level3">
<h3>Seasonality</h3>
<p>As expected, rebalance activity tracks with ridership where most of
the activity occurs in the summer months. The Bike Angel program
launched in 2018 had a profound effect on flattening this trend compared
to previous years.</p>
<figure>
<img src="https://hackmd.io/_uploads/SkoCY8cmc.png"
alt="Annual-Rebalance-Season" />
<figcaption aria-hidden="true">Annual-Rebalance-Season</figcaption>
</figure>
<p>Similarly, post Bike Angel rebalance activity tracks with ridership
where most acitivity occurs during the week supporting commuters. <img
src="https://hackmd.io/_uploads/HkqX585Xq.png"
alt="Weekly-Rebalance-Season" /></p>
</section>
<section id="bikers-dislike-going-uphill" class="level3">
<h3>Bikers Dislike Going Uphill</h3>
<p>In aggregate more bikes were rebalanced from lower elevation stations
than to, and more bikes were rebalanced to higher elevation stations
than from. This suggests bikers who ride downhill often find other modes
of transport for return trips.</p>
<p><img src="https://hackmd.io/_uploads/r1KB3N5Xc.jpg" width="350"
alt="rebalance-elevation-bins" /> <img
src="https://hackmd.io/_uploads/By422Vqm9.png" width="350"
alt="rebalance-elevation-density" /></p>
<p>This becomes even more apparent when looking at a density plot of
years pre and post launch of the Bike Angel program. In 2016, the
difference between station elevations for rebalance movements is
somewhat normally distributed. In 2019, there is a long right tail
indicating significantly more bikes are rebalanced to higher elevations
- even the Bike Angels aren’t willing to climb hills.</p>
</section>
<section id="future-analysis" class="level3">
<h3>Future Analysis?</h3>
<p>There are nearly endless ways to dive into ridership and rebalance
data to understand needs and motivations of bikeshare participants or
the general movement of individuals around New York. This analysis
focused mostly on data aggregated over the years available (2014-2000)
which helps us interpret rebalance operations as a whole. Future work
could include:</p>
<ul>
<li>Focusing on a specific year, season, or days to understand and
predict usage and rebalance needs with respect to changes in overall
ridership and events such as holidays and professional sports games</li>
<li>Comparing rides and rebalance statistics across years as docking
stations are introduced, moved, or retired to evaluate past decisions
and inform future strategy/goals</li>
<li>Developing a prective model to inform Citi Bike if a dock stations
is on track to be depleted or filled and needs immediate rebalancing
outside of normally scheduled operations</li>
</ul>
</section>
</section>
<section id="visualizing-bike-stations-and-rebalances" class="level2">
<h2>Visualizing Bike Stations and Rebalances</h2>
<p>look at our dash app!</p>
</section>
</section>
</article>
</body>
</html>
